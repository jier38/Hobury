# extends 'layout.html'
<!DOCTYPE html>
<html>

<head>
	<title>
		# block title
		${_("Line chart")}
		${ super() }
		# endblock title
	</title>
	# block head
	${ super() }
	# endblock head
</head>

<body>
	# block content
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/jquery.jqplot.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/plugins/jqplot.canvasTextRenderer.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/plugins/jqplot.dateAxisRenderer.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/plugins/jqplot.highlighter.min.js"></script>
	<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/plugins/jqplot.cursor.min.js"></script>
	<link type="text/css" rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.9/jquery.jqplot.min.css" />
	<script type="text/javascript" src="chrome/site/prices.js"></script>

	<table>
		<tr>
			<td>
				<div class="tooltip">mRS threshold: </div>
			</td>
			<td><input id="percentile" type="number" value="0.5" min="0" max="1" step="0.05" onchange="refresh();" />
			</td>
		</tr>
		<tr>
			<td>
				<div class="tooltip">Shape parameter: </div>
			</td>
			<td><input id="k" type="number" value="1.7" min="0" max="10" step="0.05" onchange="refresh();" /></td>
		</tr>
		<tr>
			<td>
				<div class="tooltip">Scale parameter: </div>
			</td>
			<td><input id="lambda" type="number" value="6" min="0" max="20" step="0.1" onchange="refresh();" /></td>
		</tr>
	</table>
	<div id="weights_graph" style="width: 500px; height: 200px;"></div>
	<div id="charts" style="padding: 40px"></div>


	<script type="text/javascript">
		var nrofperiods = 32;
		var prices = { plot: '' };
		let weights = [], lines = [], mLines = [], sLines = [], iLines = [];

		// Refreshes all charts on the page
		function refresh() {
			setWeights();
			setIndicators();
			setDisplayLines();

			// Render weights chart
			$('#weights_graph').empty();
			$.jqplot('weights_graph', [weights], {
				highlighter: { show: true },
				series: [{ lineWidth: 1, color: 'blue', showMarker: false, rendererOptions: { smooth: true } }],
				axes: { xaxis: { padMin: 0, tickOptions: { formatString: '%.1f' } }, yaxis: { padMin: 0, tickOptions: { formatString: '%.4f' } } }
			}
			);

			// Render prices charts
			$('#charts').empty();
			let fragment = document.createDocumentFragment();
			var percentile = document.getElementById("percentile").value;
			var i = 0;
			while (lines[i] !== undefined) {
				if (lines[i][0][9] < percentile) {
					var element = document.createElement('div');
					element.id = 'chart' + i.toString();
					element.style.cssText = 'margin-bottom: 40px';
					document.getElementById("charts").appendChild(element);

					prices.plot = $.jqplot('chart' + i.toString(), [lines[i], mLines[i], sLines[i]], {
						title: lines[i][0][3] + " <img src='chrome/site/" + lines[i][0][3].toLowerCase() + ".png'> " + lines[i][0][2], highlighter: { show: true }, cursor: { show: true, zoom: true },
						series: [{ lineWidth: 0.5, color: '#ccc', markerOptions: { show: false } }, { yaxis: 'y2axis', lineWidth: 0.5, color: 'blue', markerOptions: { show: false } }, { yaxis: 'y2axis', lineWidth: 0.5, color: 'lightblue', markerOptions: { show: false } }],
						axes: { xaxis: { renderer: $.jqplot.DateAxisRenderer, tickOptions: { formatString: '%Y-%m-%d' } }, yaxis: { tickOptions: { formatString: "%.2f" } }, y2axis: { tickOptions: { formatString: "%.3f", showGridline: false }, min: 0, max: 1 } }
					});
				}
				i++;
			}
		}

		// Weighting function
		function setWeights() {
			weights = [];
			var k = document.getElementById("k").value;
			var lambda = document.getElementById("lambda").value;
			for (var x = 0.1; x < nrofperiods; x++) {
				// w = Math.pow(x/lambda, k-1)*Math.exp(-x/lambda);  // gamma
				w = Math.pow(x / lambda, k - 1) * Math.exp(-Math.pow(x / lambda, k));  // weibull
				weights.push([x, w]);
			}
			// Normalise the weights
			var sumweight = 0;
			for (x in weights) sumweight += weights[x][1];
			for (x in weights) weights[x][1] /= sumweight;
		}

		// Calculate indicator values
		function setIndicators() {
			for (var i in lines) {
				for (var m = 0; m < lines[i].length - nrofperiods; m++) {
					var mUp = 0, mDown = 0, mLowIndex = 0, mHighIndex = 0, mS = 0;
					for (var w = 0; w < weights.length; w++) {
						mUp += weights[w][1] * lines[i][m + w][4];
						mDown += weights[w][1] * lines[i][m + w][5];
						mLowIndex += weights[w][1] * lines[i][m + w][6];
						mHighIndex += weights[w][1] * lines[i][m + w][7];
						mS += weights[w][1] * lines[i][m + w][8];
					}
					lines[i][m][9] = mUp / (mUp + mDown);
					lines[i][m][10] = mLowIndex / (mLowIndex + mHighIndex);
					lines[i][m][11] = mS;
				}
			}
		}

		// Create series for display into jqplot line charts
		function setDisplayLines() {
			for (var i in lines) {
				mLines[i] = [];
				iLines[i] = [];
				sLines[i] = [];
				for (var m in lines[i]) {
					mLines[i].push([lines[i][m][0], lines[i][m][9]]);
					iLines[i].push([lines[i][m][0], lines[i][m][10]]);
					sLines[i].push([lines[i][m][0], lines[i][m][11]]);
				}
			}
		}

		// Main function
		$(document).ready(function () {
			// First order statistics: up, down, lowIndex, highIndex, low, high
			let r = 0;  // row index for prices array
			while (prices_[r + nrofperiods] !== undefined) {
				var lowIndex = r, highIndex = r, low = prices_[r][3], high = prices_[r][3];
				for (var m = 0; m < nrofperiods; m++) {
					lowIndex = (prices_[r + m][3] < low) ? r + m : lowIndex;
					highIndex = (prices_[r + m][3] > high) ? r + m : highIndex;
					low = Math.min(low, prices_[r + m][3]);
					high = Math.max(high, prices_[r + m][3]);
				}
				// data structure: date [0], symbol [1], exchange [2], close [3], up [4], down [5], lowIndex [6], highIndex [7], stochast [8]
				prices_[r].push(Math.max(prices_[r][3] - prices_[r + 1][3], 0), Math.max(prices_[r + 1][3] - prices_[r][3], 0), lowIndex - r, highIndex - r, (prices_[r][3] - low) / (high - low));
				r++;
			}

			// Lines array has new column for every symbol
			let prev = '';  // last known symbol
			let j = -1;     // index for lines array
			for (r in prices_) {
				if (prev !== prices_[r][2]) {  // a new symbol requires a new lines array to be generated
					j++;
					lines[j] = [];
					prev = prices_[r][2];
				}
				// data structure: date [0], close [1], symbol [2], exchange [3], up [4], down [5], lowIndex [6], highIndex [7], stochast [8]
				lines[j].push([prices_[r][0], prices_[r][3], prices_[r][2], prices_[r][1], prices_[r][4], prices_[r][5], prices_[r][6], prices_[r][7], prices_[r][8]]);
			}
			refresh();
		})

	</script>
	# endblock content
</body>

</html>